{% comment %}
  Price Display Snippet
  Conditional price display based on B2B settings and customer tags
  
  Parameters:
  - product: Product object (required)
  - variant: Specific variant (optional, defaults to selected_or_first_available_variant)
  - show_compare: Show compare at price (default: true)
  - show_unit_price: Show unit price (default: true)
  - show_badges: Show sale/sold out badges (default: true)
  - class: Additional CSS classes
  - hide_per_product: Override global hide prices for this product (optional)
{% endcomment %}

{%- liquid
  # Get B2B detection
  render 'b2b-detect'
  
  # Determine if prices should be hidden
  assign hide_prices_global = settings.hide_prices
  assign hide_prices_b2b_only = settings.hide_prices_b2b_only
  assign product_hide_price = product.metafields.custom.hide_price | default: false
  
  if hide_per_product != nil
    assign should_hide_price = hide_per_product
  elsif product_hide_price
    assign should_hide_price = true
  elsif hide_prices_global
    assign should_hide_price = true
  elsif hide_prices_b2b_only and is_b2b_customer
    assign should_hide_price = true
  else
    assign should_hide_price = false
  endif
  
  # Get variant
  assign current_variant = variant | default: product.selected_or_first_available_variant
  
  # Price variables
  assign price = current_variant.price
  assign compare_at_price = current_variant.compare_at_price
  assign on_sale = false
  if compare_at_price > price
    assign on_sale = true
  endif
  
  # Calculate discount percentage
  assign discount_percentage = 0
  if on_sale
    assign discount = compare_at_price | minus: price
    assign discount_percentage = discount | times: 100.0 | divided_by: compare_at_price | round
  endif
  
  # Unit price
  assign has_unit_price = false
  if current_variant.unit_price_measurement
    assign has_unit_price = true
  endif
  
  # Availability
  assign available = current_variant.available
  
  # Settings defaults
  assign show_compare = show_compare | default: true
  assign show_unit_price = show_unit_price | default: true
  assign show_badges = show_badges | default: true
-%}

<div class="price-display {{ class }} {% if on_sale %}price-display--on-sale{% endif %} {% if should_hide_price %}price-display--hidden{% endif %} {% unless available %}price-display--sold-out{% endunless %}" data-price-display>
  
  {%- if should_hide_price -%}
    {%- comment -%} Hidden price - show contact/quote message {%- endcomment -%}
    <div class="price-display__hidden">
      <span class="price-display__contact">
        {{ 'products.product.contact_for_price' | t | default: 'Contact for pricing' }}
      </span>
      {%- if settings.enable_quote_system -%}
        <span class="price-display__or">{{ 'general.or' | t | default: 'or' }}</span>
        <button type="button" class="price-display__quote-link link-underline" data-quote-button
          data-product-id="{{ product.id }}"
          data-product-title="{{ product.title | escape }}"
          data-product-handle="{{ product.handle }}"
          data-product-image="{{ product.featured_image | image_url: width: 200 }}"
          data-variant-id="{{ current_variant.id }}"
          data-variant-title="{{ current_variant.title | escape }}"
        >
          {{ 'products.product.request_quote' | t | default: 'Request Quote' }}
        </button>
      {%- endif -%}
    </div>
    
  {%- else -%}
    {%- comment -%} Visible price display {%- endcomment -%}
    
    {%- if show_badges and on_sale -%}
      <span class="price-display__badge price-display__badge--sale">
        {{ 'products.product.sale' | t | default: 'Sale' }}
        {%- if settings.show_discount_percentage -%}
          <span class="price-display__discount">-{{ discount_percentage }}%</span>
        {%- endif -%}
      </span>
    {%- endif -%}
    
    {%- if show_badges and available == false -%}
      <span class="price-display__badge price-display__badge--sold-out">
        {{ 'products.product.sold_out' | t | default: 'Sold Out' }}
      </span>
    {%- endif -%}

    <div class="price-display__prices">
      {%- if on_sale and show_compare -%}
        <s class="price-display__compare" aria-label="{{ 'products.product.regular_price' | t }}">
          {{ compare_at_price | money }}
        </s>
      {%- endif -%}
      
      <span class="price-display__price" data-price>
        {%- if product.price_varies -%}
          <span class="price-display__from">{{ 'products.product.from' | t | default: 'From' }}</span>
        {%- endif -%}
        {{ price | money }}
      </span>
    </div>
    
    {%- if show_unit_price and has_unit_price -%}
      <div class="price-display__unit-price">
        <span class="visually-hidden">{{ 'products.product.unit_price' | t }}</span>
        {{ current_variant.unit_price | money }}
        <span class="price-display__unit-separator">/</span>
        {%- if current_variant.unit_price_measurement.reference_value != 1 -%}
          {{ current_variant.unit_price_measurement.reference_value }}
        {%- endif -%}
        {{ current_variant.unit_price_measurement.reference_unit }}
      </div>
    {%- endif -%}
    
    {%- comment -%} Tax/shipping notice {%- endcomment -%}
    {%- if settings.show_tax_notice -%}
      <p class="price-display__tax-notice">
        {%- if cart.taxes_included -%}
          {{ 'products.product.tax_included' | t | default: 'Tax included.' }}
        {%- endif -%}
        {%- if shop.shipping_policy.body != blank -%}
          {{ 'products.product.shipping_calculated' | t | default: 'Shipping calculated at checkout.' }}
        {%- endif -%}
      </p>
    {%- endif -%}
    
    {%- comment -%} Installment payments (Shop Pay, Klarna, etc.) {%- endcomment -%}
    {%- if settings.show_installments -%}
      {%- form 'product', product -%}
        {{ form | payment_terms }}
      {%- endform -%}
    {%- endif -%}
    
  {%- endif -%}
</div>

<style>
  .price-display {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: var(--space-2);
  }

  .price-display__prices {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: var(--space-2);
  }

  .price-display__price {
    font-family: var(--font-heading);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
  }

  .price-display--on-sale .price-display__price {
    color: var(--color-sale);
  }

  .price-display__from {
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-normal);
    color: var(--color-text-secondary);
    margin-right: var(--space-1);
  }

  .price-display__compare {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    text-decoration: line-through;
  }

  .price-display__unit-price {
    width: 100%;
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    margin-top: var(--space-1);
  }

  .price-display__unit-separator {
    margin: 0 0.1em;
  }

  /* Badges */
  .price-display__badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: 0.25em 0.75em;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-sm);
  }

  .price-display__badge--sale {
    background: var(--color-sale);
    color: white;
  }

  .price-display__badge--sold-out {
    background: var(--color-text-secondary);
    color: white;
  }

  .price-display__discount {
    font-weight: var(--font-weight-bold);
  }

  /* Hidden price state */
  .price-display--hidden {
    flex-direction: column;
    align-items: flex-start;
  }

  .price-display__hidden {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
  }

  .price-display__contact {
    font-family: var(--font-heading);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
  }

  .price-display__or {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  .price-display__quote-link {
    background: none;
    border: none;
    padding: 0;
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    cursor: pointer;
    font-weight: var(--font-weight-medium);
  }

  /* Tax notice */
  .price-display__tax-notice {
    width: 100%;
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    margin-top: var(--space-2);
  }

  /* Product card variant - smaller */
  .product-card .price-display__price {
    font-size: var(--font-size-base);
  }

  .product-card .price-display__badge {
    font-size: 10px;
    padding: 0.2em 0.5em;
  }

  /* Large variant - for product pages */
  .price-display--large .price-display__price {
    font-size: var(--font-size-2xl);
  }

  .price-display--large .price-display__compare {
    font-size: var(--font-size-lg);
  }

  /* Installments styling */
  .price-display shopify-payment-terms {
    width: 100%;
    margin-top: var(--space-2);
  }
</style>
