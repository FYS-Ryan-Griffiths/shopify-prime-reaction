{% comment %}
  Cart Upsells Snippet
  Smart product recommendations in cart
  
  Usage:
  {% render 'cart-upsells' %}
{% endcomment %}

{% liquid
  assign upsell_products = collections[settings.upsell_collection].products | default: recommendations.products
  assign cart_product_ids = cart.items | map: 'product_id'
%}

{% if upsell_products.size > 0 %}
<div class="cart-upsells" data-cart-upsells>
  <h3 class="cart-upsells__title">{{ section.settings.upsell_heading | default: 'You might also like' }}</h3>
  
  <div class="cart-upsells__slider">
    {% for product in upsell_products limit: 6 %}
      {% unless cart_product_ids contains product.id %}
      <div class="cart-upsell">
        <a href="{{ product.url }}" class="cart-upsell__image">
          {% if product.featured_image %}
            {{ product.featured_image | image_url: width: 160 | image_tag: loading: 'lazy' }}
          {% else %}
            {{ 'product-1' | placeholder_svg_tag }}
          {% endif %}
        </a>
        <div class="cart-upsell__info">
          <a href="{{ product.url }}" class="cart-upsell__title">{{ product.title | truncate: 30 }}</a>
          <span class="cart-upsell__price">{{ product.price | money }}</span>
        </div>
        <button type="button" class="cart-upsell__add btn btn--sm" data-upsell-add data-variant-id="{{ product.first_available_variant.id }}">
          <svg width="14" height="14" viewBox="0 0 14 14"><path d="M7 3V11M3 7H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Add
        </button>
      </div>
      {% endunless %}
    {% endfor %}
  </div>
</div>

<style>
.cart-upsells { padding: var(--spacing-6) 0; border-top: 1px solid var(--color-border); }
.cart-upsells__title { font-size: var(--font-size-sm); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 var(--spacing-4); }
.cart-upsells__slider { display: flex; gap: var(--spacing-4); overflow-x: auto; padding-bottom: var(--spacing-2); scrollbar-width: thin; }
.cart-upsell { flex: 0 0 140px; display: flex; flex-direction: column; gap: var(--spacing-2); }
.cart-upsell__image { width: 100%; aspect-ratio: 1; border-radius: var(--radius-md); overflow: hidden; background: var(--color-background-secondary); }
.cart-upsell__image img { width: 100%; height: 100%; object-fit: cover; }
.cart-upsell__title { font-size: var(--font-size-sm); font-weight: 500; text-decoration: none; color: var(--color-foreground); display: block; }
.cart-upsell__price { font-size: var(--font-size-sm); color: var(--color-foreground-muted); }
.cart-upsell__add { width: 100%; justify-content: center; gap: var(--spacing-1); }
</style>

<script>
document.querySelectorAll('[data-upsell-add]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const variantId = btn.dataset.variantId;
    btn.disabled = true;
    try {
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      });
      document.dispatchEvent(new CustomEvent('cart:refresh'));
    } finally {
      btn.disabled = false;
    }
  });
});
</script>
{% endif %}
