{% comment %}
  Cart Main Section
  Full cart page with line items, totals, and checkout
{% endcomment %}

<section class="cart-main section">
  <div class="container">
    <header class="cart-main__header">
      <h1 class="cart-main__title h2">{{ 'cart.general.title' | t }}</h1>
      {%- if cart.item_count > 0 -%}
        <a href="{{ routes.all_products_collection_url }}" class="cart-main__continue-shopping">
          {{ 'cart.general.continue_shopping' | t }}
        </a>
      {%- endif -%}
    </header>
    
    {%- if cart.item_count > 0 -%}
      <form action="{{ routes.cart_url }}" method="post" class="cart-main__form" data-cart-form>
        <div class="cart-main__content">
          {%- comment -%} Cart Items {%- endcomment -%}
          <div class="cart-main__items">
            <table class="cart-table">
              <thead class="cart-table__head">
                <tr>
                  <th class="cart-table__header cart-table__header--product" colspan="2">{{ 'cart.label.product' | t }}</th>
                  <th class="cart-table__header cart-table__header--price">{{ 'cart.label.price' | t }}</th>
                  <th class="cart-table__header cart-table__header--quantity">{{ 'cart.label.quantity' | t }}</th>
                  <th class="cart-table__header cart-table__header--total">{{ 'cart.label.total' | t }}</th>
                </tr>
              </thead>
              <tbody class="cart-table__body">
                {%- for item in cart.items -%}
                  <tr class="cart-item" data-cart-item data-key="{{ item.key }}">
                    {%- comment -%} Image {%- endcomment -%}
                    <td class="cart-item__image-cell">
                      <a href="{{ item.url }}" class="cart-item__image-link">
                        {%- if item.image -%}
                          <img 
                            src="{{ item.image | image_url: width: 150 }}"
                            alt="{{ item.image.alt | escape | default: item.product.title }}"
                            width="75"
                            height="75"
                            loading="lazy"
                            class="cart-item__image"
                          >
                        {%- else -%}
                          <div class="cart-item__placeholder">
                            {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                          </div>
                        {%- endif -%}
                      </a>
                    </td>
                    
                    {%- comment -%} Details {%- endcomment -%}
                    <td class="cart-item__details-cell">
                      <a href="{{ item.url }}" class="cart-item__title">{{ item.product.title }}</a>
                      
                      {%- unless item.product.has_only_default_variant -%}
                        <p class="cart-item__variant">{{ item.variant.title }}</p>
                      {%- endunless -%}
                      
                      {%- if item.selling_plan_allocation -%}
                        <p class="cart-item__selling-plan">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                      {%- endif -%}
                      
                      {%- if item.properties.size > 0 -%}
                        <ul class="cart-item__properties">
                          {%- for property in item.properties -%}
                            {%- unless property.last == blank -%}
                              <li class="cart-item__property">
                                <span class="cart-item__property-name">{{ property.first }}:</span>
                                {%- if property.last contains '/uploads/' -%}
                                  <a href="{{ property.last }}" target="_blank">{{ property.last | split: '/' | last }}</a>
                                {%- else -%}
                                  {{ property.last }}
                                {%- endif -%}
                              </li>
                            {%- endunless -%}
                          {%- endfor -%}
                        </ul>
                      {%- endif -%}
                      
                      {%- comment -%} Mobile Price {%- endcomment -%}
                      <div class="cart-item__mobile-price">
                        <span class="cart-item__price">{{ item.final_price | money }}</span>
                        {%- if item.original_price != item.final_price -%}
                          <s class="cart-item__original-price">{{ item.original_price | money }}</s>
                        {%- endif -%}
                      </div>
                      
                      {%- comment -%} Mobile Remove {%- endcomment -%}
                      <button 
                        type="button" 
                        class="cart-item__remove cart-item__remove--mobile"
                        aria-label="{{ 'cart.general.remove' | t }}"
                        data-remove-item
                        data-key="{{ item.key }}"
                      >
                        {{ 'cart.general.remove' | t }}
                      </button>
                    </td>
                    
                    {%- comment -%} Price {%- endcomment -%}
                    <td class="cart-item__price-cell">
                      <span class="cart-item__price">{{ item.final_price | money }}</span>
                      {%- if item.original_price != item.final_price -%}
                        <s class="cart-item__original-price">{{ item.original_price | money }}</s>
                      {%- endif -%}
                      
                      {%- if item.unit_price_measurement -%}
                        <span class="cart-item__unit-price">
                          {{ item.unit_price | money }}
                          <span class="cart-item__unit-price-separator">/</span>
                          {%- if item.unit_price_measurement.reference_value != 1 -%}
                            {{ item.unit_price_measurement.reference_value }}
                          {%- endif -%}
                          {{ item.unit_price_measurement.reference_unit }}
                        </span>
                      {%- endif -%}
                    </td>
                    
                    {%- comment -%} Quantity {%- endcomment -%}
                    <td class="cart-item__quantity-cell">
                      <div class="cart-item__quantity">
                        <button 
                          type="button" 
                          class="cart-item__quantity-button"
                          aria-label="{{ 'cart.general.decrease' | t }}"
                          data-decrease
                          data-key="{{ item.key }}"
                          {% if item.quantity <= 1 %}disabled{% endif %}
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                          </svg>
                        </button>
                        <input 
                          type="number" 
                          name="updates[]" 
                          value="{{ item.quantity }}" 
                          min="0"
                          max="{{ item.variant.inventory_quantity | default: 99 }}"
                          class="cart-item__quantity-input"
                          aria-label="{{ 'cart.label.quantity' | t }}"
                          data-quantity-input
                          data-key="{{ item.key }}"
                        >
                        <button 
                          type="button" 
                          class="cart-item__quantity-button"
                          aria-label="{{ 'cart.general.increase' | t }}"
                          data-increase
                          data-key="{{ item.key }}"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                          </svg>
                        </button>
                      </div>
                      
                      <button 
                        type="button" 
                        class="cart-item__remove cart-item__remove--desktop"
                        aria-label="{{ 'cart.general.remove' | t }}"
                        data-remove-item
                        data-key="{{ item.key }}"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                      </button>
                    </td>
                    
                    {%- comment -%} Total {%- endcomment -%}
                    <td class="cart-item__total-cell">
                      <span class="cart-item__line-price" data-line-price>{{ item.final_line_price | money }}</span>
                    </td>
                  </tr>
                {%- endfor -%}
              </tbody>
            </table>
          </div>
          
          {%- comment -%} Cart Summary {%- endcomment -%}
          <div class="cart-main__summary">
            <div class="cart-summary">
              {%- comment -%} Discount Codes {%- endcomment -%}
              {%- if section.settings.show_discount_code -%}
                <div class="cart-summary__discount">
                  <details class="cart-summary__discount-details">
                    <summary class="cart-summary__discount-toggle">
                      <span>{{ 'cart.general.discount_code' | t }}</span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                      </svg>
                    </summary>
                    <div class="cart-summary__discount-form">
                      <input 
                        type="text" 
                        name="discount" 
                        class="cart-summary__discount-input"
                        placeholder="{{ 'cart.general.discount_placeholder' | t }}"
                      >
                      <button type="button" class="cart-summary__discount-button button button--secondary">
                        {{ 'cart.general.apply' | t }}
                      </button>
                    </div>
                  </details>
                </div>
              {%- endif -%}
              
              {%- comment -%} Order Note {%- endcomment -%}
              {%- if section.settings.show_order_note -%}
                <div class="cart-summary__note">
                  <details class="cart-summary__note-details">
                    <summary class="cart-summary__note-toggle">
                      <span>{{ 'cart.general.note' | t }}</span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                      </svg>
                    </summary>
                    <div class="cart-summary__note-form">
                      <textarea 
                        name="note" 
                        class="cart-summary__note-input"
                        placeholder="{{ 'cart.general.note_placeholder' | t }}"
                      >{{ cart.note }}</textarea>
                    </div>
                  </details>
                </div>
              {%- endif -%}
              
              {%- comment -%} Totals {%- endcomment -%}
              <div class="cart-summary__totals">
                {%- if cart.cart_level_discount_applications.size > 0 -%}
                  <div class="cart-summary__row">
                    <span>{{ 'cart.general.subtotal' | t }}</span>
                    <span>{{ cart.original_total_price | money }}</span>
                  </div>
                  
                  {%- for discount in cart.cart_level_discount_applications -%}
                    <div class="cart-summary__row cart-summary__row--discount">
                      <span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                          <line x1="7" y1="7" x2="7.01" y2="7"/>
                        </svg>
                        {{ discount.title }}
                      </span>
                      <span>-{{ discount.total_allocated_amount | money }}</span>
                    </div>
                  {%- endfor -%}
                {%- endif -%}
                
                <div class="cart-summary__row cart-summary__row--total">
                  <span>{{ 'cart.general.total' | t }}</span>
                  <span class="cart-summary__total" data-cart-total>{{ cart.total_price | money }}</span>
                </div>
                
                <p class="cart-summary__tax-note">
                  {%- if cart.taxes_included -%}
                    {{ 'cart.general.taxes_included' | t }}
                  {%- else -%}
                    {{ 'cart.general.taxes_calculated' | t }}
                  {%- endif -%}
                </p>
              </div>
              
              {%- comment -%} Checkout Button {%- endcomment -%}
              <div class="cart-summary__actions">
                <button type="submit" name="checkout" class="cart-summary__checkout button button--primary button--large">
                  {{ 'cart.general.checkout' | t }}
                </button>
                
                {%- if additional_checkout_buttons and section.settings.show_dynamic_buttons -%}
                  <div class="cart-summary__dynamic-buttons">
                    {{ content_for_additional_checkout_buttons }}
                  </div>
                {%- endif -%}
              </div>
              
              {%- comment -%} Trust Badges {%- endcomment -%}
              {%- if section.settings.show_trust_badges -%}
                <div class="cart-summary__trust">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                  <span>{{ 'cart.general.secure_checkout' | t }}</span>
                </div>
              {%- endif -%}
            </div>
          </div>
        </div>
      </form>
    {%- else -%}
      <div class="cart-main__empty">
        <div class="cart-main__empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
        </div>
        <p class="cart-main__empty-text">{{ 'cart.general.empty' | t }}</p>
        <a href="{{ routes.all_products_collection_url }}" class="cart-main__empty-button button button--primary">
          {{ 'cart.general.start_shopping' | t }}
        </a>
      </div>
    {%- endif -%}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cartForm = document.querySelector('[data-cart-form]');
    if (!cartForm) return;
    
    // Quantity controls
    cartForm.addEventListener('click', async function(e) {
      const decreaseBtn = e.target.closest('[data-decrease]');
      const increaseBtn = e.target.closest('[data-increase]');
      const removeBtn = e.target.closest('[data-remove-item]');
      
      if (decreaseBtn || increaseBtn) {
        e.preventDefault();
        const key = (decreaseBtn || increaseBtn).dataset.key;
        const input = cartForm.querySelector(`[data-quantity-input][data-key="${key}"]`);
        const currentQty = parseInt(input.value);
        const newQty = decreaseBtn ? currentQty - 1 : currentQty + 1;
        
        if (newQty >= 0) {
          await updateCartItem(key, newQty);
        }
      }
      
      if (removeBtn) {
        e.preventDefault();
        const key = removeBtn.dataset.key;
        await updateCartItem(key, 0);
      }
    });
    
    // Quantity input change
    cartForm.addEventListener('change', async function(e) {
      const input = e.target.closest('[data-quantity-input]');
      if (input) {
        const key = input.dataset.key;
        const newQty = parseInt(input.value);
        await updateCartItem(key, newQty);
      }
    });
    
    async function updateCartItem(key, quantity) {
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: quantity })
        });
        
        if (response.ok) {
          const cart = await response.json();
          
          if (quantity === 0) {
            // Remove the item row
            const row = cartForm.querySelector(`[data-cart-item][data-key="${key}"]`);
            if (row) {
              row.style.opacity = '0';
              setTimeout(() => {
                row.remove();
                if (cart.item_count === 0) {
                  location.reload();
                }
              }, 300);
            }
          } else {
            // Update item line price
            const item = cart.items.find(item => item.key === key);
            if (item) {
              const priceEl = cartForm.querySelector(`[data-cart-item][data-key="${key}"] [data-line-price]`);
              if (priceEl) {
                priceEl.textContent = formatMoney(item.final_line_price);
              }
            }
          }
          
          // Update total
          const totalEl = document.querySelector('[data-cart-total]');
          if (totalEl) {
            totalEl.textContent = formatMoney(cart.total_price);
          }
          
          // Update cart count in header
          document.querySelectorAll('[data-cart-count]').forEach(el => {
            el.textContent = cart.item_count;
            el.classList.toggle('is-hidden', cart.item_count === 0);
          });
          
        }
      } catch (error) {
        console.error('Error updating cart:', error);
      }
    }
    
    function formatMoney(cents) {
      return (cents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code }}'
      });
    }
  });
</script>

{% schema %}
{
  "name": "Cart",
  "tag": "section",
  "class": "cart-main-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_discount_code",
      "label": "Show discount code field",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_order_note",
      "label": "Show order note field",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dynamic_buttons",
      "label": "Show dynamic checkout buttons",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_trust_badges",
      "label": "Show trust badges",
      "default": true
    }
  ]
}
{% endschema %}
