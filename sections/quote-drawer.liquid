{% comment %}
  Quote Drawer
  Slide-out drawer for quote items - alternative to modal
  Persistent across pages, shows quote cart summary
{% endcomment %}

{%- liquid
  assign show_quote = settings.enable_quote_system
-%}

{%- if show_quote -%}
  <aside 
    id="QuoteDrawer" 
    class="quote-drawer" 
    data-quote-drawer 
    aria-hidden="true" 
    role="dialog" 
    aria-labelledby="QuoteDrawerTitle"
    aria-modal="true"
  >
    <div class="quote-drawer__overlay" data-quote-drawer-close tabindex="-1"></div>
    
    <div class="quote-drawer__container">
      <header class="quote-drawer__header">
        <h2 id="QuoteDrawerTitle" class="quote-drawer__title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          {{ 'quote.drawer_title' | t | default: 'Quote Request' }}
          <span class="quote-drawer__count" data-quote-drawer-count>0</span>
        </h2>
        <button 
          type="button" 
          class="quote-drawer__close" 
          data-quote-drawer-close 
          aria-label="{{ 'accessibility.close' | t }}"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </header>

      <div class="quote-drawer__body">
        <!-- Empty State -->
        <div class="quote-drawer__empty" data-quote-drawer-empty>
          <div class="quote-drawer__empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="11" x2="12" y2="17"></line>
              <line x1="9" y1="14" x2="15" y2="14"></line>
            </svg>
          </div>
          <p class="quote-drawer__empty-title">{{ 'quote.empty_title' | t | default: 'Your quote is empty' }}</p>
          <p class="quote-drawer__empty-text">{{ 'quote.empty_text' | t | default: 'Browse products and click "Request Quote" to add items.' }}</p>
          <a href="{{ routes.collections_url }}" class="button button--primary" data-quote-drawer-close>
            {{ 'quote.browse_products' | t | default: 'Browse Products' }}
          </a>
        </div>

        <!-- Items List -->
        <div class="quote-drawer__items" data-quote-drawer-items hidden>
          <div class="quote-drawer__items-list" data-quote-drawer-items-list>
            <!-- Items dynamically inserted -->
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <footer class="quote-drawer__footer" data-quote-drawer-footer hidden>
        <div class="quote-drawer__summary">
          <span class="quote-drawer__summary-label">{{ 'quote.total_items' | t | default: 'Total items' }}:</span>
          <span class="quote-drawer__summary-count" data-quote-drawer-total>0</span>
        </div>
        
        <div class="quote-drawer__actions">
          <button type="button" class="button button--outline" data-quote-drawer-clear>
            {{ 'quote.clear' | t | default: 'Clear' }}
          </button>
          <button type="button" class="button button--primary" data-quote-drawer-proceed>
            {{ 'quote.proceed' | t | default: 'Request Quote' }}
          </button>
        </div>

        {%- if section.settings.show_convert_cart -%}
          <button type="button" class="quote-drawer__convert-cart link-underline" data-convert-cart-to-quote>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            {{ 'quote.convert_cart' | t | default: 'Convert cart to quote' }}
          </button>
        {%- endif -%}
      </footer>
    </div>
  </aside>

  <!-- Quote Toggle Button (Fixed) -->
  {%- if section.settings.show_toggle_button -%}
    <button 
      type="button" 
      class="quote-toggle-btn" 
      data-quote-drawer-toggle
      aria-label="{{ 'quote.view_quote' | t | default: 'View quote' }}"
      hidden
    >
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
      <span class="quote-toggle-btn__count" data-quote-toggle-count>0</span>
    </button>
  {%- endif -%}
{%- endif -%}

<style>
  /* Quote Drawer */
  .quote-drawer {
    position: fixed;
    inset: 0;
    z-index: 1000;
    visibility: hidden;
    pointer-events: none;
  }

  .quote-drawer.is-open {
    visibility: visible;
    pointer-events: auto;
  }

  .quote-drawer__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity var(--transition-base);
    cursor: pointer;
  }

  .quote-drawer.is-open .quote-drawer__overlay {
    opacity: 1;
  }

  .quote-drawer__container {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    max-width: 420px;
    background: var(--color-background);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform var(--transition-base);
    box-shadow: var(--shadow-xl);
  }

  .quote-drawer.is-open .quote-drawer__container {
    transform: translateX(0);
  }

  /* Header */
  .quote-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
    background: var(--color-background);
  }

  .quote-drawer__title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-size-lg);
    margin: 0;
  }

  .quote-drawer__count {
    background: var(--color-primary);
    color: var(--color-primary-contrast);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    padding: 0.125em 0.5em;
    border-radius: var(--radius-full);
    min-width: 1.5em;
    text-align: center;
  }

  .quote-drawer__close {
    background: none;
    border: none;
    padding: var(--space-2);
    cursor: pointer;
    color: var(--color-text);
    border-radius: var(--radius-md);
    transition: background-color var(--transition-fast);
  }

  .quote-drawer__close:hover {
    background: var(--color-background-secondary);
  }

  /* Body */
  .quote-drawer__body {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-4);
  }

  /* Empty State */
  .quote-drawer__empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: var(--space-10) var(--space-4);
    height: 100%;
  }

  .quote-drawer__empty-icon {
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-4);
  }

  .quote-drawer__empty-title {
    font-family: var(--font-heading);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-2);
  }

  .quote-drawer__empty-text {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
    max-width: 250px;
  }

  /* Items */
  .quote-drawer__items-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .quote-drawer-item {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-background-secondary);
    border-radius: var(--radius-md);
    position: relative;
  }

  .quote-drawer-item__image {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: var(--radius-sm);
    background: var(--color-background);
  }

  .quote-drawer-item__content {
    flex: 1;
    min-width: 0;
  }

  .quote-drawer-item__title {
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
    line-height: 1.3;
  }

  .quote-drawer-item__title a {
    color: inherit;
    text-decoration: none;
  }

  .quote-drawer-item__title a:hover {
    text-decoration: underline;
  }

  .quote-drawer-item__variant {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .quote-drawer-item__quantity {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .quote-drawer-item__quantity-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .quote-drawer-item__quantity-input {
    width: 60px;
    padding: var(--space-1) var(--space-2);
    text-align: center;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .quote-drawer-item__remove {
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    background: none;
    border: none;
    padding: var(--space-1);
    cursor: pointer;
    color: var(--color-text-tertiary);
    border-radius: var(--radius-sm);
    transition: color var(--transition-fast), background-color var(--transition-fast);
  }

  .quote-drawer-item__remove:hover {
    color: var(--color-error);
    background: var(--color-error-bg, rgba(220, 38, 38, 0.1));
  }

  /* Footer */
  .quote-drawer__footer {
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--color-border);
    background: var(--color-background);
  }

  .quote-drawer__summary {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
  }

  .quote-drawer__summary-count {
    font-weight: var(--font-weight-semibold);
  }

  .quote-drawer__actions {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .quote-drawer__convert-cart {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    background: none;
    border: none;
    padding: var(--space-2);
    cursor: pointer;
    width: 100%;
    transition: color var(--transition-fast);
  }

  .quote-drawer__convert-cart:hover {
    color: var(--color-primary);
  }

  /* Toggle Button */
  .quote-toggle-btn {
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    z-index: 100;
    background: var(--color-primary);
    color: var(--color-primary-contrast);
    border: none;
    border-radius: var(--radius-full);
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  }

  .quote-toggle-btn:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-xl);
  }

  .quote-toggle-btn__count {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--color-error);
    color: white;
    font-size: 11px;
    font-weight: var(--font-weight-bold);
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    padding: 0 4px;
  }

  /* Mobile */
  @media (max-width: 767px) {
    .quote-drawer__container {
      max-width: 100%;
    }

    .quote-toggle-btn {
      bottom: calc(var(--mobile-nav-height, 60px) + var(--space-4));
    }
  }

  /* Focus trap styles */
  .quote-drawer:focus-within .quote-drawer__container {
    outline: none;
  }

  /* Animation for items */
  .quote-drawer-item {
    animation: slideInRight 0.2s ease-out;
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .quote-drawer__container,
    .quote-drawer__overlay,
    .quote-drawer-item {
      transition: none;
      animation: none;
    }
  }
</style>

<script>
  (function() {
    'use strict';

    class QuoteDrawer {
      constructor() {
        this.drawer = document.querySelector('[data-quote-drawer]');
        if (!this.drawer) return;

        this.container = this.drawer.querySelector('.quote-drawer__container');
        this.itemsList = this.drawer.querySelector('[data-quote-drawer-items-list]');
        this.itemsContainer = this.drawer.querySelector('[data-quote-drawer-items]');
        this.emptyState = this.drawer.querySelector('[data-quote-drawer-empty]');
        this.footer = this.drawer.querySelector('[data-quote-drawer-footer]');
        this.countEls = document.querySelectorAll('[data-quote-drawer-count], [data-quote-toggle-count]');
        this.totalEl = this.drawer.querySelector('[data-quote-drawer-total]');
        this.toggleBtn = document.querySelector('[data-quote-drawer-toggle]');
        
        this.isOpen = false;
        this.focusTrap = null;
        this.lastFocusedElement = null;

        this.init();
      }

      init() {
        // Open triggers
        document.addEventListener('click', (e) => {
          const openTrigger = e.target.closest('[data-quote-drawer-open], [data-quote-drawer-toggle]');
          if (openTrigger) {
            e.preventDefault();
            this.open();
          }
        });

        // Close triggers
        this.drawer.querySelectorAll('[data-quote-drawer-close]').forEach(el => {
          el.addEventListener('click', () => this.close());
        });

        // Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isOpen) {
            this.close();
          }
        });

        // Proceed to quote form
        const proceedBtn = this.drawer.querySelector('[data-quote-drawer-proceed]');
        if (proceedBtn) {
          proceedBtn.addEventListener('click', () => {
            this.close();
            // Open quote modal or navigate to quote page
            const modal = document.querySelector('[data-quote-modal]');
            if (modal) {
              modal.classList.add('is-open');
              modal.setAttribute('aria-hidden', 'false');
            } else {
              // Navigate to quote page if no modal
              window.location.href = '{{ routes.root_url }}pages/quote';
            }
          });
        }

        // Clear items
        const clearBtn = this.drawer.querySelector('[data-quote-drawer-clear]');
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            if (confirm('{{ "quote.confirm_clear" | t | default: "Clear all items from quote?" }}')) {
              this.clearItems();
            }
          });
        }

        // Convert cart to quote
        const convertBtn = this.drawer.querySelector('[data-convert-cart-to-quote]');
        if (convertBtn) {
          convertBtn.addEventListener('click', () => this.convertCartToQuote());
        }

        // Remove item
        this.drawer.addEventListener('click', (e) => {
          const removeBtn = e.target.closest('[data-remove-quote-item]');
          if (removeBtn) {
            const itemId = removeBtn.dataset.removeQuoteItem;
            this.removeItem(itemId);
          }
        });

        // Quantity change
        this.drawer.addEventListener('change', (e) => {
          if (e.target.matches('[data-quote-item-quantity]')) {
            const itemId = e.target.dataset.quoteItemQuantity;
            const quantity = parseInt(e.target.value, 10);
            this.updateQuantity(itemId, quantity);
          }
        });

        // Listen for quote button clicks
        document.addEventListener('click', (e) => {
          const quoteBtn = e.target.closest('[data-quote-button]');
          if (quoteBtn) {
            e.preventDefault();
            this.addItemFromButton(quoteBtn);
          }
        });

        // Initial render
        this.render();

        // Listen for storage changes from other tabs
        window.addEventListener('storage', (e) => {
          if (e.key === 'quoteItems') {
            this.render();
          }
        });
      }

      getItems() {
        try {
          return JSON.parse(localStorage.getItem('quoteItems')) || [];
        } catch (e) {
          return [];
        }
      }

      saveItems(items) {
        localStorage.setItem('quoteItems', JSON.stringify(items));
        window.dispatchEvent(new CustomEvent('quote:updated'));
      }

      addItemFromButton(button) {
        const items = this.getItems();
        const item = {
          id: Date.now().toString(),
          productId: button.dataset.productId,
          productTitle: button.dataset.productTitle,
          productHandle: button.dataset.productHandle,
          productImage: button.dataset.productImage,
          variantId: button.dataset.variantId,
          variantTitle: button.dataset.variantTitle,
          variantPrice: button.dataset.variantPrice,
          quantity: 1
        };

        // Check if already exists
        const existingIndex = items.findIndex(i => 
          i.productId === item.productId && i.variantId === item.variantId
        );

        if (existingIndex >= 0) {
          items[existingIndex].quantity += 1;
        } else {
          items.push(item);
        }

        this.saveItems(items);
        this.render();
        this.open();

        // Animate button
        button.classList.add('added');
        setTimeout(() => button.classList.remove('added'), 1000);
      }

      removeItem(itemId) {
        const items = this.getItems().filter(item => item.id !== itemId);
        this.saveItems(items);
        this.render();
      }

      updateQuantity(itemId, quantity) {
        const items = this.getItems();
        const item = items.find(i => i.id === itemId);
        if (item) {
          item.quantity = Math.max(1, quantity);
          this.saveItems(items);
          this.render();
        }
      }

      clearItems() {
        this.saveItems([]);
        this.render();
      }

      async convertCartToQuote() {
        try {
          const response = await fetch('/cart.js');
          const cart = await response.json();

          if (cart.items.length === 0) {
            alert('{{ "quote.cart_empty" | t | default: "Your cart is empty" }}');
            return;
          }

          const items = this.getItems();

          cart.items.forEach(cartItem => {
            const exists = items.find(i => 
              i.productId === cartItem.product_id.toString() && 
              i.variantId === cartItem.variant_id.toString()
            );

            if (exists) {
              exists.quantity += cartItem.quantity;
            } else {
              items.push({
                id: Date.now().toString() + cartItem.variant_id,
                productId: cartItem.product_id.toString(),
                productTitle: cartItem.product_title,
                productHandle: cartItem.handle,
                productImage: cartItem.image,
                variantId: cartItem.variant_id.toString(),
                variantTitle: cartItem.variant_title !== 'Default Title' ? cartItem.variant_title : '',
                variantPrice: window.Theme?.formatMoney ? window.Theme.formatMoney(cartItem.price) : '',
                quantity: cartItem.quantity
              });
            }
          });

          this.saveItems(items);
          this.render();

        } catch (error) {
          console.error('Error converting cart:', error);
        }
      }

      render() {
        const items = this.getItems();
        const count = items.reduce((sum, item) => sum + (item.quantity || 1), 0);

        // Update counts
        this.countEls.forEach(el => el.textContent = count);
        if (this.totalEl) this.totalEl.textContent = count;

        // Toggle button visibility
        if (this.toggleBtn) {
          this.toggleBtn.hidden = count === 0;
        }

        // Toggle empty state
        const hasItems = items.length > 0;
        if (this.emptyState) this.emptyState.hidden = hasItems;
        if (this.itemsContainer) this.itemsContainer.hidden = !hasItems;
        if (this.footer) this.footer.hidden = !hasItems;

        // Render items
        if (this.itemsList) {
          this.itemsList.innerHTML = items.map(item => `
            <div class="quote-drawer-item" data-quote-drawer-item="${item.id}">
              ${item.productImage ? `
                <img 
                  src="${item.productImage}" 
                  alt="${item.productTitle}" 
                  class="quote-drawer-item__image"
                  loading="lazy"
                  width="70"
                  height="70"
                >
              ` : ''}
              <div class="quote-drawer-item__content">
                <h3 class="quote-drawer-item__title">
                  <a href="/products/${item.productHandle}">${item.productTitle}</a>
                </h3>
                ${item.variantTitle ? `<p class="quote-drawer-item__variant">${item.variantTitle}</p>` : ''}
                <div class="quote-drawer-item__quantity">
                  <label class="quote-drawer-item__quantity-label" for="quote-qty-${item.id}">Qty:</label>
                  <input 
                    type="number" 
                    id="quote-qty-${item.id}"
                    class="quote-drawer-item__quantity-input" 
                    data-quote-item-quantity="${item.id}"
                    value="${item.quantity || 1}"
                    min="1"
                    max="999"
                  >
                </div>
              </div>
              <button 
                type="button" 
                class="quote-drawer-item__remove" 
                data-remove-quote-item="${item.id}"
                aria-label="{{ 'quote.remove_item' | t | default: 'Remove item' }}"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          `).join('');
        }
      }

      open() {
        this.lastFocusedElement = document.activeElement;
        this.drawer.classList.add('is-open');
        this.drawer.setAttribute('aria-hidden', 'false');
        this.isOpen = true;
        document.body.style.overflow = 'hidden';

        // Focus first focusable element
        requestAnimationFrame(() => {
          const firstFocusable = this.container.querySelector('button, [href], input, select, textarea');
          if (firstFocusable) firstFocusable.focus();
        });
      }

      close() {
        this.drawer.classList.remove('is-open');
        this.drawer.setAttribute('aria-hidden', 'true');
        this.isOpen = false;
        document.body.style.overflow = '';

        if (this.lastFocusedElement) {
          this.lastFocusedElement.focus();
        }
      }
    }

    // Initialize when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new QuoteDrawer());
    } else {
      new QuoteDrawer();
    }
  })();
</script>

{% schema %}
{
  "name": "Quote Drawer",
  "tag": "div",
  "class": "quote-drawer-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_toggle_button",
      "label": "Show floating toggle button",
      "default": true,
      "info": "Shows a fixed button when items are in the quote"
    },
    {
      "type": "checkbox",
      "id": "show_convert_cart",
      "label": "Show 'Convert cart to quote' option",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Quote Drawer"
    }
  ]
}
{% endschema %}
